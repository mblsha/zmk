name: Build and Test ZMK Custom Drivers

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run comprehensive tests daily at 2 AM UTC
    - cron: "0 2 * * *"

jobs:
  # Quick build and unit test job for fast feedback
  quick-test:
    runs-on: ubuntu-latest
    container:
      image: docker.io/zmkfirmware/zmk-build-arm:3.5
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache west modules
        uses: actions/cache@v4
        with:
          path: |
            modules/
            tools/
            zephyr/
            bootloader/
            .west/
          key: ${{ runner.os }}-west-${{ hashFiles('app/west.yml') }}
          restore-keys: |
            ${{ runner.os }}-west-

      - name: Initialize west workspace (idempotent)
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE"
          if ! west topdir >/dev/null 2>&1; then
            west init -l app/
          fi
          west update

      - name: Check native_posix support
        id: check_native
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE"
          if west build -s app/tests/drivers_test -b native_posix --dry-run >/dev/null 2>&1; then
            echo "native_available=true" >> $GITHUB_OUTPUT
          else
            echo "native_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Build firmware (my_keyboard)
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE"
          west build -s app -b nice_nano_v2 --build-dir build-firmware -- -DSHIELD=my_keyboard

      - name: Build native_posix tests (emit DTS)
        if: steps.check_native.outputs.native_available == 'true'
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE"
          west build -s app/tests/drivers_test -b native_posix --build-dir build-test
          echo "===== zephyr.dts (tail) ====="
          tail -n 200 build-test/zephyr/zephyr.dts || true
          echo "===== emulator nodes ====="
          grep -n "drv2605@5a\|bb_trackpad@0\|i2c@0\|spi@0" build-test/zephyr/zephyr.dts || true
          echo "===== checking emulator nodes are okay ====="
          grep -q 'compatible = "ti,drv2605"' build-test/zephyr/zephyr.dts || \
            (echo "::error ::DRV2605 node missing in DTS"; exit 1)
          grep -q 'compatible = "blackberry,trackpad"' build-test/zephyr/zephyr.dts || \
            (echo "::error ::BlackBerry trackpad node missing in DTS"; exit 1)

      - name: Run unit tests with output on failure
        if: steps.check_native.outputs.native_available == 'true'
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE/build-test"
          ctest --output-on-failure || (echo "::error::Tests failed"; exit 1)

      - name: Upload firmware artifacts
        uses: actions/upload-artifact@v4
        with:
          name: firmware-${{ github.sha }}
          path: |
            build-firmware/zephyr/zmk.uf2
            build-firmware/zephyr/zmk.hex
          if-no-files-found: warn
          retention-days: 7

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: test-results-${{ github.sha }}
          path: build-test/zephyr/zephyr.exe
          if-no-files-found: ignore
          retention-days: 7

  # Comprehensive test job for thorough validation
  comprehensive-test:
    runs-on: ubuntu-latest
    container:
      image: docker.io/zmkfirmware/zmk-build-arm:3.5
    defaults:
      run:
        shell: bash
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'push' &&
       contains(github.event.head_commit.message, '[test-all]')) ||
      (github.event_name == 'pull_request' &&
       (contains(github.event.pull_request.title, '[test-all]') ||
        contains(github.event.pull_request.body, '[test-all]')))

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache west modules
        uses: actions/cache@v4
        with:
          path: |
            modules/
            tools/
            zephyr/
            bootloader/
            .west/
          key: ${{ runner.os }}-west-${{ hashFiles('app/west.yml') }}

      - name: Initialize west workspace (idempotent)
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE"
          if ! west topdir >/dev/null 2>&1; then
            west init -l app/
          fi
          west update

      - name: Check native_posix support
        id: check_native
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE"
          if west build -s app/tests/drivers_test -b native_posix --dry-run >/dev/null 2>&1; then
            echo "native_available=true" >> $GITHUB_OUTPUT
          else
            echo "native_available=false" >> $GITHUB_OUTPUT
          fi

      - name: Install additional test dependencies
        run: |
          apt-get update
          apt-get install -y --no-install-recommends lcov gcovr jq python3-yaml

      - name: Ensure test runner executable
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE/app/tests"
          git update-index --chmod=+x test-runner.sh || true
          chmod +x test-runner.sh

      - name: Run comprehensive test suite
        if: steps.check_native.outputs.native_available == 'true'
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE/app/tests"
          bash -euxo pipefail ./test-runner.sh --verbose --coverage all

      - name: Generate test report
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE"
          echo "## Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "build-test/test-results/pass-fail.log" ]; then
            PASS_COUNT=$(grep -c "^PASS:" build-test/test-results/pass-fail.log || echo "0")
            FAIL_COUNT=$(grep -c "^FAIL:" build-test/test-results/pass-fail.log || echo "0")
            TOTAL=$((PASS_COUNT + FAIL_COUNT))

            echo "- **Total Tests:** $TOTAL" >> $GITHUB_STEP_SUMMARY
            echo "- **Passed:** $PASS_COUNT" >> $GITHUB_STEP_SUMMARY
            echo "- **Failed:** $FAIL_COUNT" >> $GITHUB_STEP_SUMMARY

            if [ $TOTAL -gt 0 ]; then
              SUCCESS_RATE=$((PASS_COUNT * 100 / TOTAL))
              echo "- **Success Rate:** ${SUCCESS_RATE}%" >> $GITHUB_STEP_SUMMARY
            fi

            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Failed Tests" >> $GITHUB_STEP_SUMMARY
            if [ $FAIL_COUNT -gt 0 ]; then
              grep "^FAIL:" build-test/test-results/pass-fail.log | sed 's/FAIL: /- /' >> $GITHUB_STEP_SUMMARY
            else
              echo "None! ðŸŽ‰" >> $GITHUB_STEP_SUMMARY
            fi
          fi

      - name: Upload comprehensive test results
        uses: actions/upload-artifact@v4
        with:
          name: comprehensive-test-results-${{ github.sha }}
          path: |
            build-test/test-results/
          if-no-files-found: warn
          retention-days: 7

      - name: Upload coverage report
        uses: actions/upload-artifact@v4
        with:
          name: coverage-report-${{ github.sha }}
          path: |
            build-test/test-results/coverage/
          if-no-files-found: ignore
          retention-days: 7

  # Hardware validation job (when hardware-in-the-loop testing is available)
  hardware-validation:
    runs-on: ubuntu-latest
    if: github.event_name == 'schedule' && false # Disabled until hardware setup is available

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup hardware test environment
        run: |
          echo "Setting up hardware-in-the-loop testing..."
          # This would configure actual hardware for testing
          # - nice!nano v2 boards
          # - Sharp Memory LCD displays
          # - DRV2605 haptic drivers
          # - BlackBerry trackpads
          # - Test automation framework

      - name: Run hardware validation tests
        run: |
          echo "Running hardware validation tests..."
          # This would execute tests on real hardware
          # - Flash firmware to test boards
          # - Verify SPI/I2C communication
          # - Test peripheral functionality
          # - Measure performance metrics
          # - Validate power consumption

  code-quality:
    runs-on: ubuntu-latest
    container:
      image: docker.io/zmkfirmware/zmk-build-arm:3.5
    defaults:
      run:
        shell: bash

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Cache west modules
        uses: actions/cache@v4
        with:
          path: |
            modules/
            tools/
            zephyr/
            bootloader/
            .west/
          key: ${{ runner.os }}-west-${{ hashFiles('app/west.yml') }}
          restore-keys: |
            ${{ runner.os }}-west-

      - name: Initialize west workspace (idempotent)
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE"
          if ! west topdir >/dev/null 2>&1; then
            west init -l app/
          fi
          west update

      - name: Generate compile database
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE"
          west build -s app -b nice_nano_v2 --build-dir build-quality -- \
            -DSHIELD=my_keyboard \
            -DCMAKE_EXPORT_COMPILE_COMMANDS=ON

      - name: Install code quality tools
        run: |
          apt-get update
          apt-get install -y --no-install-recommends clang-format cppcheck clang-tidy

      - name: Check code formatting
        continue-on-error: true
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE"
          if command -v clang-format >/dev/null 2>&1; then
            find app/drivers -name "*.c" -o -name "*.h" | \
              xargs -r clang-format --dry-run --Werror || {
                echo "Formatting differences detected; not failing build (soft enforcement).";
              }
          else
            echo "clang-format not available, skipping"
          fi

      - name: Run static analysis
        run: |
          set -euxo pipefail
          cd "$GITHUB_WORKSPACE"
          # Run cppcheck with compile database and tuned suppressions
          cppcheck \
            --project="${GITHUB_WORKSPACE}/build-quality/compile_commands.json" \
            --suppressions-list="${GITHUB_WORKSPACE}/cppcheck-suppressions.txt" \
            --error-exitcode=1 \
            --enable=warning,style,performance,portability \
            --inline-suppr \
            --suppress=missingIncludeSystem \
            --suppress=unusedFunction \
            --suppress=unmatchedSuppression

      - name: Check device tree formatting
        run: |
          find app/boards app/dts -name "*.overlay" -o -name "*.dtsi" -o -name "*.dts" | \
          while read file; do
            echo "Checking $file"
            if [ -f "$file" ]; then
              # Verify device tree syntax
              head -1 "$file" | grep -q "^/" || echo "Warning: $file may not start with root node"
              # Check for common device tree issues
              if grep -q "compatible.*=" "$file"; then
                echo "âœ“ $file has compatible strings"
              fi
            fi
          done

      - name: Install Python YAML module
        run: |
          apt-get update
          apt-get install -y python3-yaml

      - name: Validate device tree bindings
        run: |
          # Check that all custom bindings have proper YAML definitions
          find app/dts/bindings -name "*.yaml" | while read binding; do
            echo "Validating binding: $binding"
            # Basic YAML syntax check
            python3 -c "import yaml; yaml.safe_load(open('$binding'))" || exit 1
            echo "âœ“ $binding is valid YAML"
          done

  # Security analysis job
  security-analysis:
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request' || github.event_name == 'schedule'

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run security scanning
        uses: github/super-linter@v5
        env:
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_C: true
          VALIDATE_YAML: true
          VALIDATE_MARKDOWN: true
          VALIDATE_GITHUB_ACTIONS: true

      - name: Check for sensitive data
        run: |
          # Check for accidentally committed sensitive data
          if grep -r "password\|secret\|key.*=" app/ --include="*.c" --include="*.h" --include="*.yml"; then
            echo "âŒ Potential sensitive data found in source code"
            exit 1
          else
            echo "âœ… No sensitive data detected"
          fi

  # Documentation and examples validation
  documentation:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Validate documentation
        run: |
          # Check that all custom drivers have documentation
          for driver in app/drivers/*/; do
            driver_name=$(basename "$driver")
            if [ ! -f "CLAUDE.md" ] || ! grep -q "$driver_name" CLAUDE.md; then
              echo "Warning: $driver_name may need documentation updates"
            fi
          done

      - name: Check example configurations
        run: |
          # Validate that example configurations are buildable
          echo "Validating example configurations..."

          # Check that device tree examples are syntactically correct
          for overlay in app/boards/shields/*/*.overlay; do
            if [ -f "$overlay" ]; then
              echo "Checking $overlay for syntax issues..."
              # Basic device tree validation could be added here
            fi
          done

      - name: Generate API documentation
        run: |
          # Generate documentation for custom driver APIs
          mkdir -p docs/api

          echo "# ZMK Custom Driver API Reference" > docs/api/README.md
          echo "" >> docs/api/README.md
          echo "Generated: $(date)" >> docs/api/README.md
          echo "" >> docs/api/README.md

          # Extract function prototypes and documentation from headers
          find app/include -name "*.h" -exec grep -l "drv2605\|blackberry\|trackpad" {} \; | \
          while read header; do
            echo "## $(basename $header)" >> docs/api/README.md
            grep -A 5 "^\s*\*\*\|^/\*\*\|^\s*[a-zA-Z_].*(" "$header" | head -20 >> docs/api/README.md
            echo "" >> docs/api/README.md
          done

      - name: Upload documentation
        uses: actions/upload-artifact@v4
        with:
          name: documentation-${{ github.sha }}
          path: docs/
          if-no-files-found: ignore
          retention-days: 7
